# Project description (descripion.md)

Ниже — краткое описание известных файлов. Файл будет обновляться по мере изменений и анализа кода.

- __client/src/components/MessageList.tsx__
  - Экспорт: `default function MessageList({ messages, canLoadMore, onLoadMoreTop, onRequestFile, onOpenGalleryAt })`
  - Назначение: список сообщений чата с поддержкой догрузки сверху, отображением медиа (фото/видео/голос/стикеры/GIF), модального просмотра и истории версий сообщений.
  - Важные вспомогательные части:
    - `renderMessageText(text, entities)` — рендер текста с Telegram-entity разметкой.
    - `VideoWithState({ src, msgKey })` — `<video>` со стабильным состоянием времени и паузы между ремаунтами.
    - Кеш `urlCacheRef` для `Blob` → `ObjectURL`, чтобы не мигали превью при обновлениях.
    - Наблюдение видимости `observeFile(el, m)` через `IntersectionObserver` для ленивой загрузки медиа.
    - `MessageItem` — мемоизированный элемент сообщения с тонкой проверкой равенства, чтобы не дергать соседние элементы/видео.
    - Логика прокрутки: сохранение позиции по `dialogId`, восстановление при входе, корректный якорь при догрузке сверху.
  - Загрузка истории чата:
    - При входе в диалог показывается «хвост» из кэша (IndexedDB): только последние N сообщений (окно), без очистки кэша. Используется хук `useMessagesWindow(dialogId, { limit })`.
    - Параллельно выполняется `getHistory(..., 1)` — если пришло более новое сообщение, чем в кэше, оно добавляется в БД.
    - При прокрутке вверх сначала увеличиваем окно (показываем больше из кэша). Если кэш исчерпан — запрашиваем старые сообщения малыми партиями через `getMoreHistory(..., 20)`.
    - Позиция скролла при добавлении сверху сохраняется, скачки предотвращены.
    - Медиа не префетчится агрессивно; полные файлы загружаются только при появлении сообщения в зоне видимости через `IntersectionObserver` (`observeFile`). Для самого нового сообщения медиа скачивается, если оно есть и не превышает 20MB.
  - Прогрессивная подгрузка: верхний `IntersectionObserver`-сентинел вызывает `onLoadMoreTop()` при приближении к верху (rootMargin≈300px), добавляя предыдущие сообщения.
  - Кнопка «вниз»: фиксированная в правом нижнем углу области, отображается если пользователь далеко от низа; по клику — прокрутка к последнему сообщению.
    - Счётчик новых сообщений на кнопке: увеличивается, если пришли новые сообщения и пользователь не у низа; сбрасывается при достижении низа/клике/смене диалога.
    - Аватарки: показываются реальные `avatarSmall` для диалога и для отправителей (`db.users` по `fromId`), при отсутствии — инициалы.

- __client/src/components/Composer.tsx__
  - Предположительно: поле ввода и отправка сообщений (будет дополнено после анализа).

- __client/src/components/DialogsList.tsx__
  - Список диалогов. Для каждого диалога отображает реальный аватар `d.avatarSmall` (если есть) либо инициалы названия.
  - Параметры: `dialogs: DBDialog[]`, `hasMore?: boolean`, `onLoadMore?: () => void`, `activeId?: string`, `onSelect(id: string, entity?: any)`.
  - Дозагрузка: через IntersectionObserver-сентинел внизу списка, без дерганий и лишних вызовов.
  - Поиск по Telegram:
    - Контакты/чаты: `searchContacts(q)`; клики передают `id` и `entity` в `onSelect`.
    - Сообщения: `searchGlobalMessages(q)`; по клику — переход в диалог.
    - Дебаунс 300мс, индикатор «Поиск…», пустые состояния.
    - Аватары результатов: сначала из IndexedDB (`db.dialogs`/`db.users`), при отсутствии скачиваются из сети через `downloadPeerAvatarSmall(entity)` и кэшируются.

- __client/src/components/MediaModal.tsx__
  - Предположительно: модальное окно для просмотра медиа (будет дополнено после анализа).

- __client/src/components/MediaGalleryModal.tsx__
  - Предположительно: модальное окно-галерея для навигации по медиа (будет дополнено после анализа).

- __client/src/components/MediaFolderModal.tsx__
  - Предположительно: модалка выбора/папки медиа (будет дополнено после анализа).

-- __client/src/lib/telegramClient.ts__
  - Новое/важное:
    - `type DialogsPageCursor = { offsetDate?, offsetPeer?, offsetId? }` — курсор пагинации диалогов; `offsetId` всегда msgId (int32), не peerId.
    - `getDialogsPage(limit = 50, cursor?)` — постраничная загрузка диалогов; возвращает `{ peers, nextCursor, hasMore }`.
    - `searchContacts(query, limit)` — глобальный поиск по контактам/чатам через `contacts.Search`.
    - `searchGlobalMessages(query, limit)` — глобальный поиск по сообщениям через `messages.SearchGlobal` с параметрами `offsetPeer=InputPeerEmpty`, `offsetRate=0`, `filter=InputMessagesFilterEmpty`.
    - `joinChannelIfNeeded(entity)` — попытка вступить/подписаться для доступа к истории канала/супергруппы.

-- __client/src/App.tsx__
  - Интегрирована пагинация диалогов: хранит `dialogsHasMore`, `dialogsCursorRef`, загружает первую страницу через `getDialogsPage(50)`, подгружает следующие страницы при `onLoadMore` из `DialogsList` и кладёт в IndexedDB через `upsertDialogs`.
  - Переход из поиска: если `onSelect(id, entity)` передал `entity`, он кэшируется и используется для мгновенной загрузки истории.
  - Доступ к каналам с ограничениями: при ошибке доступа показывается кнопка «Вступить/Подписаться»; по клику выполняется `joinChannelIfNeeded` и повторная загрузка истории.
  - Стратегия загрузки истории: при входе в диалог грузится только одно последнее сообщение (`getHistory(..., 1)`). Остальная история подгружается малыми пачками при достижении верха списка.
  - Автозагрузка медиа: только для самого нового сообщения, если размер ≤ 20MB; старые медиа не скачиваются автоматически.


Примечание: при следующих изменениях файл будет обновлён с детальными сигнатурами и назначением функций по каждому компоненту.
